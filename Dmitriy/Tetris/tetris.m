clear;rand('state',sum(100*clock));[killsnd,fskill,bits] = wavread('kill.wav');[nextsnd,fsnext,bits] = wavread('nextlevel.wav');[endsnd,fsend,bits] = wavread('endgame.wav');opengl neverselect;scrsize = get(0,'screensize');figheight = 0.9*scrsize(4);fieldwidth = 12;fieldheight = 20;colmatr = hsv(6);fig = figure('Name','Matlab Tetris','NumberTitle','off','MenuBar','none','position',[fix((scrsize(3)-figheight)/2) fix((scrsize(4)-figheight)/2) figheight figheight],...    'doublebuffer','on','units','pixels','resize','off');gcgame = subplot('position',[.05 .05 .9*(fieldwidth/fieldheight) .9]);set(gcgame,'xtick',[],'ytick',[],'xlim',[0 fieldwidth],'ylim',[0 fieldheight],'color',[0 0 0]);axis manualhold onmatr = zeros(fieldheight+4,fieldwidth+4);tetr = {[1 1; 1 1],[1 0; 1 1; 1 0],[1; 1; 1; 1],[1 1; 1 0; 1 0],[1 0; 1 1; 0 1]};set(gcf,'keypressfcn','kp = sum(get(gcf,''currentcharacter'')); TetrisKeyPress');uicontrol('Style','text','units','normalized','string','Score','position',[.1+.9*(fieldwidth/fieldheight) .9 1-(.1+.9*(fieldwidth/fieldheight)) .05], ...    'FontSize',18,'Fontweight','bold','BackgroundColor',[.8 .8 .8]);txscore = uicontrol('Style','text','units','normalized','string','0','position',[.1+.9*(fieldwidth/fieldheight) .85 1-(.1+.9*(fieldwidth/fieldheight)) .05], ...    'FontSize',16,'Fontweight','bold','BackgroundColor',[.8 .8 .8],'ForegroundColor',[1 0 0]);uicontrol('Style','text','units','normalized','string','Level','position',[.1+.9*(fieldwidth/fieldheight) .75 1-(.1+.9*(fieldwidth/fieldheight)) .05], ...    'FontSize',18,'Fontweight','bold','BackgroundColor',[.8 .8 .8]);txlevel = uicontrol('Style','text','units','normalized','string','1','position',[.1+.9*(fieldwidth/fieldheight) .7 1-(.1+.9*(fieldwidth/fieldheight)) .05], ...    'FontSize',16,'Fontweight','bold','BackgroundColor',[.8 .8 .8],'ForegroundColor',[1 0 0]);uicontrol('Style','text','units','normalized','string','Next shape','position',[.1+.9*(fieldwidth/fieldheight) .6 1-(.1+.9*(fieldwidth/fieldheight)) .05], ...    'FontSize',18,'Fontweight','bold','BackgroundColor',[.8 .8 .8]);uicontrol('Style','text','units','normalized','string',{'Matlab Tetris','(c)2004 by Dmitriy Aronov'},'position',[.1+.9*(fieldwidth/fieldheight) .1 1-(.1+.9*(fieldwidth/fieldheight)) .1], ...    'FontSize',11,'Fontweight','bold','BackgroundColor',[.8 .8 .8]);gameon = 1;score = 0;level = 1;totfig = 0;kp = 0;fignum = fix(rand*length(tetr))+1;nextfig = tetr{fignum};isflip = round(rand);if isflip    nextfig = fliplr(nextfig);endif rand    nextfig = flipud(nextfig);endnextcl = colmatr(fix(rand*size(colmatr,1))+1,:);while gameon    h = [];    currfig = nextfig;    currcl = nextcl;        fignum = fix(rand*length(tetr))+1;    nextfig = tetr{fignum};    isflip = round(rand);    if isflip        nextfig = fliplr(nextfig);    end    if rand        nextfig = flipud(nextfig);    end    nextcl = colmatr(fix(rand*size(colmatr,1))+1,:);    set(gcf,'keypressfcn','%');    subplot('position',[(1+.1+.9*(fieldwidth/fieldheight))/2-(.9/fieldheight)*size(nextfig,2)/2 .55-size(nextfig,1)*.9/fieldheight size(nextfig,2)*.9/fieldheight size(nextfig,1)*.9/fieldheight]);    set(gca,'xlim',[0 size(nextfig,2)],'ylim',[0 size(nextfig,1)]);    delete(get(gca,'children'));    hold on    for c = 1:size(nextfig,1)        for d = 1:size(nextfig,2)            if nextfig(c,d) == 1                patch([d-1 d d d-1],[c-1 c-1 c c],nextcl);            end        end    end    axis off    drawnow    subplot('position',[.05 .05 .9*(fieldwidth/fieldheight) .9]);    set(gcf,'keypressfcn','kp = sum(get(gcf,''currentcharacter'')); TetrisKeyPress');        figy = fieldheight;    figx = round(fieldwidth/2-1);    for c = 1:size(currfig,1)        for d = 1:size(currfig,2)            if currfig(c,d) == 1                h = [h patch([figx+d-1 figx+d figx+d figx+d-1],[figy+c-1 figy+c-1 figy+c figy+c],currcl)];            end        end    end    drawnow        while 1        isbad = 0;        for c = 1:length(h)            miny = min(get(h(c),'ydata'));            minx = min(get(h(c),'xdata'));            if min(get(h(c),'ydata')) == 0                isbad = 1;                break            end            if matr(miny,minx+1) == 1                isbad = 1;                break            end        end        if isbad == 1            break        end        for c = 1:length(h)            set(h(c),'ydata',get(h(c),'ydata')-1);        end        figy = figy-1;                if gameon == 0            break        end        drawnow        pausetime = 0.8^(level+1);        pause(pausetime);    end        for c = 1:length(h)        miny = min(get(h(c),'ydata'));        minx = min(get(h(c),'xdata'));        if miny >= fieldheight            set(gcf,'keypressfcn','%');            gameon = 0;            sound(endsnd,fsend);            break        end        matr(miny+1,minx+1) = 1;    end        f = find(sum(matr,2)==fieldwidth);    if ~isempty(f)        score = score + 10*round(2^length(f)*10*sqrt(level));        sound(killsnd,fskill);    else        score = score + 10*round(sqrt(level));    end    for c = length(f):-1:1        matr(f(c):end-1,:) = matr(f(c)+1:end,:);        matr(end,:) = 0;        m = get(gca,'children');        for mind = 1:length(m)            ys = get(m(mind),'ydata');            if min(ys) > f(c)-1                set(m(mind),'ydata',ys-1);            elseif min(ys) == f(c)-1;                delete(m(mind));            end        end        drawnow    end        if totfig > level*20;        level = level+1;        sound(nextsnd,fsnext);    end    set(txscore,'string',num2str(score));    set(txlevel,'string',num2str(level))    totfig = totfig+1;endload recordsif score > records(10)    prompt = {['You obtained a record score of ' num2str(score) '. Enter your name.']};    dlg_title = 'Record score';    num_lines= 1;    def     = {'Anonymous'};    answer  = inputdlg(prompt,dlg_title,num_lines,def);    if isempty(answer)        answer = 'Anonymous';    else        answer = answer{1};    end    if length(answer) > 20        answer = answer(1:20);    else        answer = [answer repmat(' ',1,20-length(answer))];    end       names(11,:) = answer;    records(11) = score;        [records i] = sort(records);    records = fliplr(records);    i = fliplr(i);    names = names(i,:);    f = find(i==11);        records = records(1:10);    names = names(1:10,:);    save records records names    delete(get(gcf,'children'));    recheight = 0.7*scrsize(4);    recwidth = 0.6*scrsize(4);    set(gcf,'position',[fix((scrsize(3)-recwidth)/2) fix((scrsize(4)-recheight)/2) recwidth recheight]);    for c = 1:10        tx(1) = uicontrol('Style','text','Units','normalized','String',num2str(c),'Position',[.05 .92-.07*c .05 .05],'FontSize',12,'FontWeight','Bold','BackgroundColor',[.8 .8 .8],'Horizontalalignment','right');        tx(2) = uicontrol('Style','text','Units','normalized','String',names(c,:),'Position',[.15 .92-.07*c .55 .05],'FontSize',12,'FontWeight','Bold','BackgroundColor',[.8 .8 .8],'Horizontalalignment','left');        tx(3) = uicontrol('Style','text','Units','normalized','String',num2str(records(c)),'Position',[.75 .92-.07*c .20 .05],'FontSize',12,'FontWeight','Bold','BackgroundColor',[.8 .8 .8],'Horizontalalignment','right');        if c == f            set(tx,'foregroundcolor',[1 0 0]);        end    end        uicontrol('Style','pushbutton','Units','normalized','String','OK','Position',[.4 .1 .2 .05],'FontSize',12,'Callback','isrec = 1; TetrisEndGame;');else   isrec = 0;   TetrisEndGame;end