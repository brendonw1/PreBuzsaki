function keptupstates=reviewupstates(upstates,abfnotes);keptupstates=upstates;for a=1:size(upstates,1);%for each slice    for b=1:size(upstates,2);%for each data record        for bb=1:size(upstates,3);%for each trace in that record           emp(bb)=~isempty(upstates{a,b,bb});%record        end        if sum(emp)>0;            name1=abfnotes{a}.abfname{b};%get name of the electrophys recording to open from the abfnotes cell            load(name1);%load data from that file into the workspace... this will have multiple traces in it as columns of the variable "data"            channels=channelnames(header);            match=[];            for c=1:size(upstates,3);                if ~isempty(upstates{a,b,c});%if upstates detected;                    if c==1;%figuring out which channel corresponds with which tracenumber, so that trace can be displayed                        for q=1:size(channels,2);                            if strcmp(channels(q),'IN 5') | strcmp(channels(q),'IN 15');                                match(q)=1;                            else                                match(q)=0;                            end                        end                    elseif c==2;                        for q=1:size(channels,2);                            if strcmp(channels(q),'IN 10') | strcmp(channels(q),'IN 7');                                match(q)=1;                            else                                match(q)=0;                            end                        end                    elseif c==3;                        for q=1:size(channels,2);                            if strcmp(channels(q),'IN 14');                                match(q)=1;                            else                                match(q)=0;                            end                        end                    end                    match=find(match);                    reading=data(:,match);                      ups=upstates{a,b,c};%bring in upstate matrix, which is x by 4                    for d=size(ups,1):-1:1;%for each detected upstate (going backwards);                        disp([num2str(a),' ',num2str(b),' ',num2str(c),' ',name1,'. UP voltage = ',num2str(round(mean(reading(ups(d,2):ups(d,3))))),'. ','DOWN voltage = ',num2str(round(mean([reading(ups(d,1)) reading(ups(d,4))])))]);                        figure;                        hold on;                        plot(reading);                        title (['Slice ',num2str(a),'. Cell ',num2str(c)]);%                         if c==1;%                             title('IN 5');% %                             disp('IN 5');%                         elseif c==2;%                             title('IN 10');% %                             disp('IN 10');%                         elseif c==3;%                             title('IN 14');% %                             disp('IN 14');%                         end                        for e=1:size(ups,1);                            for f=1:4;                                plot(ups(e,f),reading(ups(e,f)),'*','color','g');%make other upstates green                            end                        end                        for g=1:4;                            plot(ups(d,g),reading(ups(d,g)),'*','color','r');%make the selected one red                        end                        x=0;                        while x<1;                            ans2=input ('Keep this upstate?  y or n: ','s');                            if strcmp('n',ans2);                                y=0;                                while y<1;                                    ans3=input('Are you sure? y or n: ','s');                                    if strcmp('n',ans3);                                        y=1;                                    elseif strcmp('y',ans3);                                        disp('This will NOT be kept');                                        keptupstates{a,b,c}(d,:)=[];%delete that upstate                                        x=1;                                        y=1;                                    else                                        ('Are you sure? Enter "y" or "n"')                                    end                                end                            elseif strcmp('y',ans2);                                disp('This upstate will be KEPT');                                x=1;%do nothing                            else                                 disp ('Enter "y" or "n"')                            end                        end                        close                    end                end            end        end        clear name1 data comments labels header%memory management    endend